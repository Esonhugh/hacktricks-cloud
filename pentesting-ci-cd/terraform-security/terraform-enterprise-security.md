# Terraform Enterprise Security

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basic Information

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) is hashicorp self-hosted distribution of [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs). It offers enterprises a **private instance of the Terraform Cloud application**, with no resource limits and with additional enterprise-grade architectural features like audit logging and SAML single sign-on.

"By default, Terraform Enterprise **does not prevent Terraform operations from accessing the instance metadata service**, which may contain IAM credentials or other sensitive data" ([source](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
While the focus of this article is on targeting the metadata service, it is worth noting that gaining code execution inside a Terraform run may provide other avenues for attack. For example, environment variables could be leaked which may contain sensitive credentials.
{% endhint %}

## Remote Terraform Execution <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud runs Terraform on **disposable virtual machines in its own cloud infrastructure** by default. You can leverage [Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents) to run Terraform on **your own isolated, private, or on-premises infrastructure**. Remote Terraform execution is sometimes referred to as "remote operations."

Therefore, with an API key to contact Terraform Enterprise it's possible to **execute arbitrary code in a container in the cloud**.

[**Terraform API Tokens**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) can be identified by the **`.atlasv1.` substring**. They are usually located in `~/.terraform.d/` but attacking CI/CD platforms and clouds you might find them in secrets or env variables.

You can use this token to **find the Organization:**

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```

and with this info find the Workspace:

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```

Now you need to create a config to communicate with the terraform Enterprise backend. Just get [this example](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) and **add a `hostname`** with the hostname of the Terraform Enterprise instance:

{% code title="backend_config.tf" %}
```json
terraform {
  backend "remote" {
    hostname = "{{TFE_HOSTNAME}}"
    organization = "{{ORGANIZATION_NAME}}"

    workspaces {
      name = "{{WORKSPACE_NAME}}"
    }
  }
}
```
{% endcode %}

Initialise your terraform to use the Terraform Enterprise token

```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```

Now that you have **Terraform configured to contact the Enterprise backend** you can just follow the section [**RCE in Terraform**](./#rce-in-terraform) from:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoting

As it was previously mentined, Terrafomr Enterprise Infra may run in any machine/cloud provides using agents. Therefore, if you can execute code in this machine, you could gather **cloud credentials from the metadata endpoint (**[**IAM, user data...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Moreover, check the **filesystem** and **environment variables** for other potential secrets and API keys.\
Also, don't forget to **check the network** where the machine is located.

## Protections

{% hint style="info" %}
#### Disabling Remote Operations <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Many of Terraform Cloud's features rely on remote execution and are not available when using local operations. This includes features like Sentinel policy enforcement, cost estimation, and notifications.

You can disable remote operations for any workspace by changing its [Execution Mode](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) to **Local**. This causes the workspace to act only as a remote backend for Terraform state, with all execution occurring on your own workstations or continuous integration workers.
{% endhint %}

{% hint style="info" %}
**Restrict Terraform Build Worker Metadata Access**

By default, Terraform Enterprise does not prevent Terraform operations from accessing the instance metadata service, which may contain IAM credentials or other sensitive data. Refer to [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows), or [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) documentation for more information on this service.
{% endhint %}

## References

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
