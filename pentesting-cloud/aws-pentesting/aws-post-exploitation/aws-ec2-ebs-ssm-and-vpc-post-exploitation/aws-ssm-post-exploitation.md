# AWS - SSM Post-Exploitation

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**This post was copied from** [**https://frichetten.com/blog/ssm-agent-tomfoolery/**](https://frichetten.com/blog/ssm-agent-tomfoolery/)****

## Intercept SSM Communications

### Intercept EC2 Messages <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Due to how SSM handles authentication, if you can get **access to the IAM credentials of an EC2 instance you can intercept EC2 messages and SSM sessions**.

[**SSM Agent**](https://github.com/aws/amazon-ssm-agent) will constantly call **`ec2messages:GetMessages`**. By default the agent will do this constantly, keeping the **connection open** for approximately **20 seconds**. During this 20 second interval, the agent is **listening** for messages. If it receives one, such as when someone calls [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), it will **receive the message** via this open connection.

An **attacker** can call more frequently **`ec2messages:GetMessages`**, and this will allow us to i**ntercept EC2 messages coming to the instance**. This is because the messages will be sent to the last one that stablished a connection (so as long as an attacker do it more frequently, he will get the messages).To test this idea, you can use this simple [**proof of concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) that will listen for send-command messages and steal the command.

The attacker could also **send any response** he likes to the messages.

### Intercept SSM Sessions

This is more complex as it involves multiple web socket connections, a unique binary protocol, and more. The following is a summation of the relevant concepts.

Shortly after the **SSM Agent starts up**, it will **create** a **WebSocket** connection back to AWS. This connection is the control channel, and is responsible for listening for connections. When a user tries to start an SSM session ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), the **control channel will receive the request and will spawn a data channel**. The data channel is responsible for the actual communication from the user to the EC2 instance.

The communication that takes place between the clients is a binary protocol specifically for this purpose. Thankfully, the source code for the SSM Agent is available [here](https://github.com/aws/amazon-ssm-agent), and we can just look up the specification for it. It looks something like [this](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

![](<../../../../.gitbook/assets/image (4) (1) (1).png>)

From an abuse perspective, **intercepting SSM Sessions is more reliable than EC2 messages**. The reason for this is that the **control channels are long lived**, and just like with EC2 messages AWS will only communicate with the **newest one**. As a result, we can create our own control channel and listen for incoming sessions. Using the SSM Agent source code, we can craft the messages in the binary format (if you look to the [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), you‚Äôll notice I‚Äôve literally just translated the Go to Python), and interact with the session.

Because of this we can do things like the following.

![](<../../../../.gitbook/assets/image (45).png>)

Alternatively, we could do things like stealing the commands and supplying our own output. For example, trying to snoop on credentials being passed to the machine.

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
