# AWS - Abusing Lambda Extensions

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Lambda Extensions

Lambda extensions enable you to augment your functions. For example, you can use extensions to integrate your functions with your preferred monitoring, observability, security, and governance tools. You add extensions to .zip archives functions using [Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), or include them in the image for [functions deployed as container images](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* **Internal extensions** run as **part** of the **runtime** process, **in-process** with your code. They allow you to modify the **startup of the runtime process** using language-specific environment variables and wrapper scripts. Internal extensions enable use cases such as automatically instrumenting code.
* **External extensions** allow you to **run separate processes** from the runtime but still within the **same execution environment** as the Lambda function. External extensions can **start before the runtime** process, and can **continue after the runtime** shuts down. External extensions enable use cases such as fetching secrets before the invocation, or sending telemetry to a custom destination outside of the function invocation. These extensions run as companion processes to Lambda functions.

For more information about [**how lambda extensions work check the docs**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### External Extension for Persistence, Stealing Requests & modifying Requests

**This is going to be a summary for the technique proposed in this post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

The researchers found that the default Linux kernel in the Lambda runtime environment is compiled with ‚Äú**process\_vm\_readv**‚Äù and ‚Äú**process\_vm\_writev**‚Äù system calls. And all processes run with the same user ID, even the new process created for the external extension. **This means that an external extension has full read and write access to Rapid‚Äôs heap memory, by design.**

Moreover, Lambda **extensions** can **subscribe** to **invocation events**; however, AWS does not expose the raw data to the extension. So the extension won't be able to gather sensitive information sent in the HTTP request.

The **Init** (Rapid) process listens for all API requests on **http://127.0.0.1:9001**. Lambda **extensions** are loaded and **executed** before any runtime code, but **after Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

The **variable** named ‚Äú**AWS\_LAMBDA\_RUNTIME\_API**‚Äù **informs** the child **runtime** processes and other extensions of the **IP and port number of the Rapid API**.

{% hint style="warning" %}
**Overwriting** this environment variable with a **port number that we control** will allow us to **man-in-the-middle all activity** within the Lambda runtime.\
And because the kernel is compiled with those system calls and the **extension** is **running** with the **same user ID** as the Rapid Init, it's possible to **overwrite** the process **memory** and **change the port**.
{% endhint %}

Since **extensions execute before any runtime code**, the **updated environment variable will take effect when the runtime process is executed** (Python, Java, Node, Ruby, etc). In addition, any extensions that are loaded after ours, and use this variable, will be proxied through our extension as well. This could allow malware to **completely disable security products or logging extensions from within the runtime itself**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

The tool [**lambda-spy**](https://github.com/clearvector/lambda-spy) was created to perform that **memory write** and **steal sensitive information** from lambda requests, other **extensions** **requests** and even **modify them**.

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
